---
# Задачи для отката конфигурации брокера

- name: Поиск бэкапа для отката
  find:
    paths: "{{ config_backup_path | default('./config_backups') }}"
    patterns: "broker-{{ kafka_broker_id }}-*.backup"
    sort: "mtime"
  register: backup_files
  delegate_to: localhost

- name: Выбор последнего бэкапа
  set_fact:
    rollback_backup: "{{ backup_files.files | sort(attribute='mtime', reverse=true) | first }}"
  when: backup_files.matched > 0

- name: Откат конфигурации из бэкапа
  command: >
    docker exec {{ kafka_container }} kafka-configs
    --bootstrap-server {{ kafka_internal_bootstrap }}
    --entity-type brokers
    --entity-name {{ kafka_broker_id }}
    --alter
    --add-config {{ rollback_config }}
  vars:
    rollback_config: "{{ lookup('file', rollback_backup.path) | regex_replace('.*Configs for broker.*', '') | regex_replace('\\s+', '') }}"
  delegate_to: localhost
  when: rollback_backup is defined
  register: rollback_applied

- name: Вывод информации об откате
  debug:
    msg: "Конфигурация брокера {{ kafka_broker_id }} откачена из бэкапа {{ rollback_backup.path }}"
  when: rollback_backup is defined
